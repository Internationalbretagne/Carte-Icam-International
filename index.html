<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Carte Interactive ICAM</title>
  <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/v2.6.1/mapbox-gl.css"/>
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.6.1/mapbox-gl.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      background-color: #fff8e1;
      overflow-y: hidden;
    }

    #container {
      display: flex;
    }

    #map {
      width: 80%;
      height: 66vh;
      border-radius: 10px;
      border: 2px solid #ffa726;
    }

    #sidebar {
      width: 20%;
      height: 59vh;
      overflow-y: auto;
      padding: 20px;
      margin: 5px;
      margin-top: 0px;
      background: #f7941e;
      border-radius: 10px;
      border: 2px solid #ffa726;
      color: white;
    }

    #search,  
    #promoFilter {
      width: 90%;
      padding: 10px;
      margin: 10px;
      border: 2px solid #f7941e;
      border-radius: 5px;
    }

    #logo {
      position: absolute;
      top: 10px;
      left: 10px;
      width: 80px;
      height: auto;
      z-index: 999;
    }

    .marker {
      cursor: pointer;
    }

    .autocomplete-items {
      position: absolute;
      border: 1px solid #ddd;
      border-top: none;
      z-index: 99;
      background-color: #fff;
      width: 100%;
      max-height: 200px;
      overflow-y: auto;
      border-radius: 0 0 5px 5px;
      left: 0;
    }


    .autocomplete-item {
      padding: 10px;
      cursor: pointer;
      text-align: left;
    }

    .autocomplete-item:hover {
      background-color: #f7941e;
      color: white;
    }
  </style>  
</head>
<body>
  <img id="logo" src="Logo_Icam.png" alt="Logo">
  <h2>Carte Interactive ICAM</h2>

  <div style="position: relative; display: inline-block; width: 90%;">
    <input type="text" id="search" placeholder="Rechercher un pays ou une ville..." 
           oninput="showSuggestions()" onkeyup="filterMarkers()" />
    <div id="autocomplete-list" class="autocomplete-items"></div>
  </div>

  <select id="promoFilter" onchange="filterByPromo()">
    <option value="all">Toutes promotions</option>
  </select>

  <div id="container">
    <div id="map"></div>
    <div id="sidebar">
      <h3>Informations</h3>
      <p>Sélectionnez un marqueur pour afficher les détails ici.</p>
    </div>
  </div>

  <script>
    mapboxgl.accessToken = 'pk.eyJ1IjoiZ3VydmFuZnIiLCJhIjoiY203MjI5Y2EyMDR2eTJpc2ZjM3llazFwNSJ9._1ih1opeFU9RbWn8GZ0lyA';

    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v11',
        center: [10, 50],
        zoom: 2
    });

    let markers = [];
    let promos = new Set();
    let allNames = [];

    function createMarkerElement() {
        const el = document.createElement('div');
        el.className = 'marker';
        el.style.backgroundImage = 'url("Marqueur_Icam.png")';
        el.style.width = '30px';
        el.style.height = '30px';
        el.style.backgroundSize = 'cover';
        el.style.cursor = 'pointer';
        return el;
    }

    function loadCSV() {
        fetch('Donnee_etudiant_Excel.csv')
        .then(response => {
            if (!response.ok) throw new Error("Fichier CSV introuvable.");
            return response.text();
        })
        .then(data => {
            Papa.parse(data, {
            header: true,
            skipEmptyLines: true,
            delimiter: ";",
            complete: function(results) {
                processData(results.data);
                populatePromoFilter();
            }
            });
        })
        .catch(error => {
            console.error("Erreur de chargement du CSV :", error);
            alert("Le fichier CSV n'a pas pu être chargé. Utilisez Live Server pour ouvrir ce fichier.");
        });
    }

    function processData(data) {
        const countries = {};
        const cities = {};
        markers.forEach(markerObj => markerObj.marker.remove());
        markers = [];
        allNames = [];

        data.forEach(row => {
            const country = (row["Pays"] || "").trim();
            const city = (row["Ville"] || "").trim();
            const lat = parseFloat((row["Latitude"] || "0").replace(",", "."));
            const lon = parseFloat((row["Longitude"] || "0").replace(",", "."));
            const student = `${row["Prenom"]} ${row["Nom"]} (${row["Promotion"]})`;
            const promo = (row["Promotion"] || "").trim();
            promos.add(promo);

            if (country) allNames.push(country);
            if (city) allNames.push(city);

            if (promo === "2025") {
                if (!countries[country]) countries[country] = { lat, lon, students: [], promoSet: new Set() };
                countries[country].students.push(student);
                countries[country].promoSet.add(promo);
            }

            if (promo === "2026" || promo === "2027") {
                if (!cities[city]) cities[city] = { lat, lon, students: [], promoSet: new Set() };
                cities[city].students.push(student);
                cities[city].promoSet.add(promo);
            }
        });

        allNames = [...new Set(allNames)];

        Object.keys(countries).forEach(country => {
            const loc = countries[country];
            const marker = new mapboxgl.Marker(createMarkerElement())
                .setLngLat([loc.lon, loc.lat])
                .addTo(map);

            marker.getElement().addEventListener('click', () => {
                document.getElementById("sidebar").innerHTML =
                `<h3>${country}</h3><ul>` + loc.students.map(s => `<li>${s}</li>`).join('') + `</ul>`;
            });

            markers.push({ name: country, marker, promos: loc.promoSet, students: loc.students });
        });

        Object.keys(cities).forEach(city => {
            const loc = cities[city];
            const marker = new mapboxgl.Marker(createMarkerElement())
                .setLngLat([loc.lon, loc.lat])
                .addTo(map);

            marker.getElement().addEventListener('click', () => {
                document.getElementById("sidebar").innerHTML =
                `<h3>${city}</h3><ul>` + loc.students.map(s => `<li>${s}</li>`).join('') + `</ul>`;
            });

            markers.push({ name: city, marker, promos: loc.promoSet, students: loc.students });
        });
    }

    function filterMarkers() {
        const input = document.getElementById("search").value.toLowerCase();
        markers.forEach(markerObj => {
            const label = (markerObj.name || "").toLowerCase();
            markerObj.marker.getElement().style.display = label.includes(input) ? "block" : "none";
        });
    }

    function filterByPromo() {
        const selectedPromo = document.getElementById("promoFilter").value;
        markers.forEach(markerObj => {
            markerObj.marker.getElement().style.display =
                selectedPromo === "all" || markerObj.promos.has(selectedPromo) ? "block" : "none";
        });
    }

    function populatePromoFilter() {
        const promoFilter = document.getElementById("promoFilter");
        promoFilter.innerHTML = '<option value="all">Toutes promotions</option>';
        promos.forEach(promo => {
            const option = document.createElement("option");
            option.value = promo;
            option.textContent = `Promotion ${promo}`;
            promoFilter.appendChild(option);
        });
    }

    function showSuggestions() {
      const input = document.getElementById("search");
      const listContainer = document.getElementById("autocomplete-list");
      const val = input.value.toLowerCase();
      listContainer.innerHTML = "";
      if (!val) return;

      const suggestions = allNames.filter(name => name.toLowerCase().startsWith(val)).slice(0, 8);

      suggestions.forEach(name => {
          const item = document.createElement("div");
          item.className = "autocomplete-item";
          item.innerHTML = `<strong>${name.substr(0, val.length)}</strong>${name.substr(val.length)}`;
          item.addEventListener("click", () => {
              input.value = name;
              listContainer.innerHTML = "";
              filterMarkers();

              const markerObj = markers.find(m => m.name === name);
              if (markerObj) {
                  const lngLat = markerObj.marker.getLngLat();
                  map.flyTo({ center: [lngLat.lng, lngLat.lat], zoom: 6 });

                  document.getElementById("sidebar").innerHTML =
                      `<h3>${name}</h3><ul>` +
                      markerObj.students.map(s => `<li>${s}</li>`).join('') +
                      `</ul>`;
              }
        });
        listContainer.appendChild(item);
      });
    }

    document.addEventListener("click", (e) => {
        if (!e.target.closest("#search")) {
            document.getElementById("autocomplete-list").innerHTML = "";
        }
    });

    loadCSV();
  </script>
</body>
</html>
